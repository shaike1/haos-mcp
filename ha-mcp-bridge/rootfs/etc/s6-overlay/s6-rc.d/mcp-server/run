#!/usr/bin/with-contenv bashio
# ==============================================================================
# Start MCP Server service - SIMPLIFIED VERSION
# ==============================================================================

bashio::log.info "Starting HA MCP Bridge Add-on..."
bashio::log.info "Version: 2.4.4 (Ingress Test)"

# Load configuration
ADMIN_PASSWORD="$(bashio::config 'admin_password')"
NABU_CASA_URL="$(bashio::config 'nabu_casa_url')"

# Use fixed port 3003 as defined in config.yaml
export PORT="3003"
export LOG_LEVEL="info"

# Basic OAuth configuration
export OAUTH_ENABLED="true"
export ADMIN_USERNAME="admin"
export ADMIN_PASSWORD="${ADMIN_PASSWORD}"

# Home Assistant integration using supervisor token
export HA_URL="http://supervisor/core"
export HA_TOKEN="${SUPERVISOR_TOKEN}"

# CORS origins for Claude.ai
export CORS_ORIGIN="https://claude.ai,https://app.claude.ai"

# Simple URL display
CLAUDE_URL="https://ha.right-api.com/15715349_ha-mcp-bridge-v2/ingress"

bashio::log.info ""
bashio::log.info "ðŸŽ¯ =================================="
bashio::log.info "ðŸŽ¯    CLAUDE.AI SETUP INSTRUCTIONS"
bashio::log.info "ðŸŽ¯ =================================="
bashio::log.info ""
bashio::log.info "ðŸ“‹ Copy this URL for Claude.ai:"
bashio::log.info "ðŸ”— ${CLAUDE_URL}"
bashio::log.info ""
bashio::log.info "ðŸ“‹ No authentication required!"
bashio::log.info "âœ… Claude.ai can connect directly"
bashio::log.info ""
bashio::log.info "ðŸŽ¯ =================================="
bashio::log.info ""

# Change to application directory
cd /app

# Start the TEST server first to verify addon is running
bashio::log.info "ðŸ§ª Starting TEST server to verify addon..."
bashio::log.info "ðŸ§ª This will help diagnose if ingress routing works"
exec node /usr/bin/test-server.js